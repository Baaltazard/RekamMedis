<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Form Input Data Pasien</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
      #loading {
        display: none;
        position: absolute;
        right: 10px;
        top: 30px;
      }
      .select2-container--bootstrap4 .select2-selection {
        padding-right: 30px;
      }
    </style>
  </head>
  <body class="p-4 bg-light">
    <div class="container bg-white shadow rounded p-4">
      <a href="index.html" class="btn btn-danger mb-4 shadow"
        >Back To Dashboard</a
      >
      <h3 class="mb-4">Form Input Data Pasien</h3>
      <form id="pasienForm">
        <div class="col-md-4 position-relative">
          <label class="form-label">Cari Nama Pasien</label>
          <select
            id="nama"
            name="nama"
            class="form-select select2bs4"
            required
          ></select>
          <div id="loading" class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <hr />
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Nama Pasien</label>
            <input
              type="text"
              name="nama_pasien"
              id="nama_pasien"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Tanggal</label>
            <input
              type="date"
              name="tanggal"
              id="tanggal"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-4">
            <label class="form-label">Kunjungan</label>
            <input type="text" name="kunjungan" class="form-control" />
          </div>

          <div class="col-md-4">
            <label class="form-label">No Reg</label
            ><input name="noreg" id="noreg" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">No BPJS</label
            ><input name="bpjs" id="bpjs" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">No KTP</label
            ><input name="ktp" id="ktp" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">No HP</label
            ><input name="hp" id="hp" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">L/P</label
            ><input name="jk" id="jk" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Tanggal Lahir</label
            ><input type="date" name="lahir" id="lahir" class="form-control" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Umur</label
            ><input name="umur" id="umur" class="form-control" />
          </div>
          <div class="col-md-8">
            <label class="form-label">Alamat</label
            ><input name="alamat" id="alamat" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Tensi</label
            ><input name="tensi" id="tensi" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Nadi</label
            ><input name="nadi" id="nadi" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Suhu</label
            ><input name="suhu" id="suhu" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Pernapasan</label
            ><input name="pernapasan" id="pernapasan" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Tinggi</label
            ><input name="tinggi" id="tinggi" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Berat</label
            ><input name="berat" id="berat" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Lingkar Perut</label
            ><input name="lingkar" id="lingkar" class="form-control" />
          </div>
          <div class="col-md-12">
            <label class="form-label">Keluhan</label
            ><textarea
              name="keluhan"
              id="keluhan"
              class="form-control"
            ></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label">Diagnosa</label
            ><textarea
              name="diagnosa"
              id="diagnosa"
              class="form-control"
            ></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label">Terapi</label
            ><textarea
              name="terapi"
              id="terapi"
              class="form-control"
            ></textarea>
          </div>
          <div class="col-md-12">
            <label class="form-label">Tindakan</label
            ><textarea
              name="tindakan"
              id="tindakan"
              class="form-control"
            ></textarea>
          </div>
          <div class="col-md-4">
            <label class="form-label">Biaya</label
            ><input name="biaya" id="biaya" class="form-control" />
          </div>
        </div>
        <button type="submit" id="submitBtn" class="btn btn-primary mt-4">
          <span id="submitText">Simpan Data</span>
          <span
            id="submitSpinner"
            class="spinner-border spinner-border-sm d-none ms-2"
            role="status"
            aria-hidden="true"
          ></span>
        </button>
      </form>
      <div id="loading" class="text-center mt-4" style="display: none">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Memuat data, mohon tunggu...</p>
      </div>
    </div>

    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycby6WXvYTeZcRpVb6UtkM4EMODKXJQKYF2nFdO5qIg6NvOeyMooIsL-yXm2Neoj7dYdg-Q/exec";

      function formatDate(dateStr) {
        const d = new Date(dateStr);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function calculateAge(birthDateStr) {
        const today = new Date();
        const birthDate = new Date(birthDateStr);
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      }

      $(document).ready(function () {
        $("#tanggal").val(new Date().toISOString().split("T")[0]);

        $(".select2bs4").select2({
          theme: "bootstrap4",
          placeholder: "Cari Nama Pasien",
          ajax: {
            url: scriptURL + "?mode=select2",
            dataType: "json",
            delay: 250,
            data: (params) => ({ name: params.term }),
            processResults: (data) => ({
              results: data.data.map((item) => ({
                id: item[3],
                text: item[3],
              })),
            }),
          },
        });

        $("#nama").on("select2:select", function (e) {
          const nama = e.params.data.text.toLowerCase();
          $("#loading").show();
          $.getJSON(scriptURL + "?mode=detail&name=" + nama, function (res) {
            $("#loading").hide();
            if (res.data.length > 0) {
              const d = res.data[0];
              $("#nama_pasien").val(d[3]);
              $("#noreg").val(d[4]);
              $("#bpjs").val(d[5]);
              $("#ktp").val(d[6]);
              $("#hp").val(d[7]);
              $("#jk").val(d[8]);
              $("#lahir").val(formatDate(d[9]));
              const birthDate = d[9];
              $("#umur").val(birthDate ? calculateAge(birthDate) : "");
              $("#alamat").val(d[11]);
              $("#tensi").val(d[12]);
              $("#nadi").val(d[13]);
              $("#suhu").val(d[14]);
              $("#pernapasan").val(d[15]);
              $("#tinggi").val(d[16]);
              $("#berat").val(d[17]);
              $("#lingkar").val(d[18]);
              $("#keluhan").val(d[19]);
              $("#diagnosa").val(d[20]);
              $("#terapi").val(d[21]);
              $("#tindakan").val(d[22]);
              $("#biaya").val(d[23]);
            } else {
              Swal.fire(
                "Pasien tidak ditemukan",
                "Silakan isi data secara manual",
                "info"
              );
              $("#pasienForm")[0].reset();
            }
          });
        });

        // Update umur when tanggal lahir is manually entered
        $("#lahir").on("change", function () {
          const birthDate = $(this).val();
          if (birthDate) {
            $("#umur").val(calculateAge(birthDate));
          } else {
            $("#umur").val("");
          }
        });

        $("#pasienForm").on("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          const submitBtn = $("#submitBtn");
          const submitText = $("#submitText");
          const submitSpinner = $("#submitSpinner");

          submitBtn.prop("disabled", true);
          submitText.text("Menyimpan...");
          submitSpinner.removeClass("d-none");
          $("#loading").fadeIn();

          $.ajax({
            url: scriptURL,
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function () {
              Swal.fire({
                icon: "success",
                title: "Berhasil",
                text: "Data pasien berhasil disimpan!",
                timer: 2000,
                showConfirmButton: false,
              });
              $("#pasienForm")[0].reset();
            },
            error: function () {
              Swal.fire({
                icon: "error",
                title: "Gagal",
                text: "Terjadi kesalahan, silakan coba lagi.",
              });
            },
            complete: function () {
              submitBtn.prop("disabled", false);
              submitText.text("Simpan Data");
              submitSpinner.addClass("d-none");
              $("#loading").fadeOut();
            },
          });
        });
      });
    </script>
  </body>
</html>
